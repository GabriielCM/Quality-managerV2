// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  nome      String
  email     String   @unique
  senha     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  permissions UserPermission[]
  refreshTokens RefreshToken[]
  incs        Inc[]
  rncs        Rnc[]
  rncHistoricos RncHistorico[]
  notificationSettings UserNotificationSetting[]
  notifications        Notification[]
  devolucoesCriadas               Devolucao[] @relation("DevolucaoCriadoPor")
  devolucoesNfeEmitida            Devolucao[] @relation("DevolucaoNfeEmitidaPor")
  devolucoesColetaConfirmada      Devolucao[] @relation("DevolucaoColetaConfirmadaPor")
  devolucoesRecebimentoConfirmado Devolucao[] @relation("DevolucaoRecebimentoConfirmadaPor")
  devolucoesCompensacaoConfirmada Devolucao[] @relation("DevolucaoCompensacaoConfirmadaPor")

  @@map("users")
}

model Permission {
  id          String   @id @default(uuid())
  code        String   @unique // ex: "inc.create", "inc.read", "users.manage"
  name        String
  description String?
  module      String   // ex: "inc", "users", "dashboard"
  createdAt   DateTime @default(now())

  users UserPermission[]

  @@map("permissions")
}

model UserPermission {
  id           String @id @default(uuid())
  userId       String
  permissionId String

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@map("user_permissions")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// Módulo INC
model Inc {
  id                       String   @id @default(uuid())
  data                     DateTime @default(now())
  ar                       Int
  nfeNumero                String
  nfeAnexo                 String?  // path do arquivo
  um                       String   // UN, KG, M, etc
  quantidadeRecebida       Float
  quantidadeComDefeito     Float
  descricaoNaoConformidade String?
  status                   String   @default("Em análise") // "Em análise", "Aprovado", "Rejeitado", "Aprovado por concessão", "RNC enviada"
  criadoPorId              String
  fornecedorId             String
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  // Relacionamentos
  criadoPor  User        @relation(fields: [criadoPorId], references: [id])
  fornecedor Fornecedor  @relation(fields: [fornecedorId], references: [id])
  fotos      IncFoto[]
  rncs       Rnc[]

  @@map("incs")
}

model IncFoto {
  id        String   @id @default(uuid())
  incId     String
  path      String
  filename  String
  createdAt DateTime @default(now())

  inc Inc @relation(fields: [incId], references: [id], onDelete: Cascade)

  @@map("inc_fotos")
}

// Módulo Fornecedores
model Fornecedor {
  id           String   @id @default(uuid())
  cnpj         String   @unique // Armazenado sem máscara (apenas números)
  razaoSocial  String
  codigoLogix  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relacionamentos
  incs Inc[]
  rncs Rnc[]

  @@map("fornecedores")
}

// Enum para status de devolução
enum DevolucaoStatus {
  RNC_ACEITA
  DEVOLUCAO_SOLICITADA
  NFE_EMITIDA
  DEVOLUCAO_COLETADA
  DEVOLUCAO_RECEBIDA
  FINALIZADO
}

// Enum para meio de compensação
enum MeioCompensacao {
  TRANSFERENCIA_DIRETA
  COMPENSACAO_PAGAMENTOS_FUTUROS
}

// Módulo RNC (Relatório de Não Conformidade)
model Rnc {
  id                       String   @id @default(uuid())
  numero                   String   @unique // RNC:001/2025
  sequencial               Int      // 1, 2, 3... (por fornecedor/ano)
  ano                      Int      // 2025, 2026...
  data                     DateTime @default(now())

  // Dados importados da INC
  ar                       Int
  nfeNumero                String
  um                       String
  quantidadeRecebida       Float
  quantidadeComDefeito     Float
  descricaoNaoConformidade String

  // Campos específicos da RNC
  reincidente              Boolean  @default(false)
  rncAnteriorId            String?  // Se reincidente, referência à RNC anterior
  status                   String   @default("RNC enviada") // "RNC enviada", "Aguardando resposta", "Em análise", "Concluída", "RNC aceita"
  pdfPath                  String?  // Caminho do PDF gerado automaticamente
  planoAcaoPdfPath         String?  // Caminho do PDF do plano de ação do fornecedor
  prazoInicio              DateTime? // Data de início do prazo atual de 7 dias

  // Relacionamentos
  incId                    String
  fornecedorId             String
  criadoPorId              String

  inc          Inc         @relation(fields: [incId], references: [id])
  fornecedor   Fornecedor  @relation(fields: [fornecedorId], references: [id])
  criadoPor    User        @relation(fields: [criadoPorId], references: [id])
  rncAnterior  Rnc?        @relation("RncReincidente", fields: [rncAnteriorId], references: [id])
  rncsFilhas   Rnc[]       @relation("RncReincidente")
  historico    RncHistorico[]
  devolucao    Devolucao?

  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@unique([fornecedorId, sequencial, ano])
  @@map("rncs")
}

// Histórico de aceites e recusas de planos de ação
model RncHistorico {
  id            String   @id @default(uuid())
  rncId         String
  tipo          String   // "ACEITE" ou "RECUSA"
  data          DateTime @default(now())
  pdfPath       String   // Caminho do PDF anexado
  justificativa String?  // Justificativa (obrigatória apenas para RECUSA)
  prazoInicio   DateTime // Data de início do prazo de 7 dias
  prazoFim      DateTime // Data de fim do prazo (prazoInicio + 7 dias)
  criadoPorId   String

  // Relacionamentos
  rnc        Rnc  @relation(fields: [rncId], references: [id], onDelete: Cascade)
  criadoPor  User @relation(fields: [criadoPorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("rnc_historico")
}

// Módulo de Devolução
model Devolucao {
  id                   String          @id @default(uuid())
  rncId                String          @unique  // Relacionamento 1:1 com RNC

  // Etapa 1 - Solicitação de Faturamento
  arOrigem             Int
  quantidadeTotal      Float
  pesoKg               Float
  motivo               String
  transportadora       String
  frete                String          // "FOB" ou "CIF"
  meioCompensacao      MeioCompensacao

  // Etapa 2 - Emissão da NF-e
  nfeNumero            String?
  nfePdfPath           String?
  nfeEmitidaPorId      String?
  nfeEmitidaEm         DateTime?

  // Etapa 3a - Confirmação de Coleta
  dataColeta           DateTime?
  coletaConfirmadaPorId String?

  // Etapa 3b - Confirmação de Recebimento
  dataRecebimento      DateTime?
  recebimentoConfirmadoPorId String?

  // Etapa 4 - Compensação Fiscal
  dataCompensacao      DateTime?
  comprovantePath      String?         // Caminho do comprovante (PDF ou imagem)
  compensacaoConfirmadaPorId String?

  // Controle
  status               DevolucaoStatus @default(RNC_ACEITA)
  criadoPorId          String
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  // Relacionamentos
  rnc                  Rnc             @relation(fields: [rncId], references: [id], onDelete: Cascade)
  criadoPor            User            @relation("DevolucaoCriadoPor", fields: [criadoPorId], references: [id])
  nfeEmitidaPor        User?           @relation("DevolucaoNfeEmitidaPor", fields: [nfeEmitidaPorId], references: [id])
  coletaConfirmadaPor  User?           @relation("DevolucaoColetaConfirmadaPor", fields: [coletaConfirmadaPorId], references: [id])
  recebimentoConfirmadoPor User?       @relation("DevolucaoRecebimentoConfirmadaPor", fields: [recebimentoConfirmadoPorId], references: [id])
  compensacaoConfirmadaPor User?       @relation("DevolucaoCompensacaoConfirmadaPor", fields: [compensacaoConfirmadaPorId], references: [id])

  @@map("devolucoes")
}

// Módulo de Notificações
// Tipo de notificação (template/configuração)
model NotificationType {
  id          String   @id @default(uuid())
  codigo      String   @unique // "rnc_prazo_2dias", "rnc_prazo_1dia"
  nome        String   // "RNC - Prazo 2 Dias"
  descricao   String   // Descrição detalhada
  modulo      String   // "rnc", "inc", etc
  canal       String   @default("sistema") // "sistema", "email" (futuro)
  ativo       Boolean  @default(true) // Admin pode desativar globalmente
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userSettings  UserNotificationSetting[]
  notifications Notification[]

  @@map("notification_types")
}

// Configurações de notificação por usuário
model UserNotificationSetting {
  id                 String   @id @default(uuid())
  userId             String
  notificationTypeId String
  habilitado         Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationType NotificationType @relation(fields: [notificationTypeId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationTypeId])
  @@map("user_notification_settings")
}

// Instância de notificação enviada
model Notification {
  id                 String   @id @default(uuid())
  notificationTypeId String
  userId             String
  titulo             String
  mensagem           String
  urgente            Boolean  @default(false)
  lida               Boolean  @default(false)
  dataLeitura        DateTime?

  // Contexto para navegação
  entityType         String?  // "rnc", "inc"
  entityId           String?

  // Prevenção de duplicatas
  uniqueKey          String   @unique

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  notificationType NotificationType @relation(fields: [notificationTypeId], references: [id])
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, lida])
  @@index([createdAt])
  @@map("notifications")
}
